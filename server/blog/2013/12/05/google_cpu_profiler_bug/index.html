<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="/js/jquery-1.7.1.min.js"></script>
	<script type="text/javascript">
    var switch_flag_=0
    $(document).ready(function(){
            $("#float_top_right").css({ top: "10px",right: "10px", width: "200", position: "fixed", background: "#99ff00" })
                .css({"border-style": "solid"});
            $("#float_top_right").prepend("<div id=float_top_right_header>点击切换位置</div>");
            $("#float_top_right_header").css({ width: "100%"}).css({ height: "20"})
                .css({ background: "#9900ff" }).css("cursor","pointer")
            
            // OnClick做实际的事情
            $("#float_top_right_header").click(function(event){
                event.preventDefault();
                if(switch_flag_){
                    $("#float_top_right").css({ bottom: ""});
                    $("#float_top_right").css({ top: "10px"});
                }else{
                    $("#float_top_right").css({ top: ""});
                    $("#float_top_right").css({ bottom: "10px"});
                }
                switch_flag_= !switch_flag_;
            });
	})
	</script>
    <title>Google CpuProfiler在x64 Linux下的问题</title>
</head>
<body>
    <table align="left" border="0" cellpadding="0" cellspacing="0" style="width: 100%; ">
        <tbody>
            <tr>
                <td>
                    <link href="/js/google-code-prettify/prettify.css" type="text/css" rel="stylesheet"/>
<script type="text/javascript" src="/js/google-code-prettify/prettify.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $('pre').addClass('prettyprint linenums:0') //添加Google code Hight需要的class
	
	// 导入Prettify的javascript
    prettyPrint()
})
</script>
<strong>导航：[<a href="/">首页</a>]->[<a href="/categories/other/">other</a>]->[<a href="/blog/2013/12/05/google_cpu_profiler_bug">Google CpuProfiler在x64 Linux下的问题</a>]</strong>

<p>Google出品的gperftools cpu profiler程序，以其良好的支持多线程、动态库等一系列亮点广受欢迎，不过最近在x64 Linux下却怎么都取样不了。于是发现了个tip需要注意。</p>

<p>原文如下</p>

<h2><a href="https://code.google.com/p/gperftools/source/browse/INSTALL">https://code.google.com/p/gperftools/source/browse/INSTALL</a>：</h2>

<pre><code>*** NOTE FOR 64-BIT LINUX SYSTEMS

The glibc built-in stack-unwinder on 64-bit systems has some problems
with the perftools libraries.  (In particular, the cpu/heap profiler
may be in the middle of malloc, holding some malloc-related locks when
they invoke the stack unwinder.  The built-in stack unwinder may call
malloc recursively, which may require the thread to acquire a lock it
already holds: deadlock.)

For that reason, if you use a 64-bit system, we strongly recommend you
install libunwind before trying to configure or install gperftools.
libunwind can be found at

   http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99-beta.tar.gz

Even if you already have libunwind installed, you should check the
version.  Versions older than this will not work properly; too-new
versions introduce new code that does not work well with perftools
(because libunwind can call malloc, which will lead to deadlock).

There have been reports of crashes with libunwind 0.99 (see
http://code.google.com/p/gperftools/issues/detail?id=374).
Alternately, you can use a more recent libunwind (e.g. 1.0.1) at the
cost of adding a bit of boilerplate to your code.  For details, see
http://groups.google.com/group/google-perftools/msg/2686d9f24ac4365f

   CAUTION: if you install libunwind from the url above, be aware that
   you may have trouble if you try to statically link your binary with
   perftools: that is, if you link with 'gcc -static -lgcc_eh ...'.
   This is because both libunwind and libgcc implement the same C++
   exception handling APIs, but they implement them differently on
   some platforms.  This is not likely to be a problem on ia64, but
   may be on x86-64.

   Also, if you link binaries statically, make sure that you add
   -Wl,--eh-frame-hdr to your linker options. This is required so that
   libunwind can find the information generated by the compiler
   required for stack unwinding.

   Using -static is rare, though, so unless you know this will affect
   you it probably won't.

If you cannot or do not wish to install libunwind, you can still try
to use the built-in stack unwinder.  The built-in stack unwinder
requires that your application, the tcmalloc library, and system
libraries like libc, all be compiled with a frame pointer.  This is
*not* the default for x86-64.

If you are on x86-64 system, know that you have a set of system
libraries with frame-pointers enabled, and compile all your
applications with -fno-omit-frame-pointer, then you can enable the
built-in perftools stack unwinder by passing the
--enable-frame-pointers flag to configure.

Even with the use of libunwind, there are still known problems with
stack unwinding on 64-bit systems, particularly x86-64.  See the
"64-BIT ISSUES" section in README.

If you encounter problems, try compiling perftools with './configure
--enable-frame-pointers'.  Note you will need to compile your
application with frame pointers (via 'gcc -fno-omit-frame-pointer
...') in this case.
</code></pre>

<h2><a href="https://code.google.com/p/gperftools/source/browse/README">https://code.google.com/p/gperftools/source/browse/README</a></h2>

<pre><code>CPU PROFILER
------------
See doc/cpu-profiler.html for information about how to use the CPU
profiler and analyze its output.

As a quick-start, do the following after installing this package:

1) Link your executable with -lprofiler
2) Run your executable with the CPUPROFILE environment var set:
     $ CPUPROFILE=/tmp/prof.out &lt;path/to/binary&gt; [binary args]
3) Run pprof to analyze the CPU usage
     $ pprof &lt;path/to/binary&gt; /tmp/prof.out      # -pg-like text output
     $ pprof --gv &lt;path/to/binary&gt; /tmp/prof.out # really cool graphical output

There are other environment variables, besides CPUPROFILE, you can set
to adjust the cpu-profiler behavior; cf "ENVIRONMENT VARIABLES" below.

The CPU profiler is available on all unix-based systems we've tested;
see INSTALL for more details.  It is not currently available on Windows.

NOTE: CPU profiling doesn't work after fork (unless you immediately
      do an exec()-like call afterwards).  Furthermore, if you do
      fork, and the child calls exit(), it may corrupt the profile
      data.  You can use _exit() to work around this.  We hope to have
      a fix for both problems in the next release of perftools
      (hopefully perftools 1.2).
</code></pre>

<p>其中有几点：</p>

<ol>
<li>最好是安装libunwind，并且不要最新版本</li>
<li>configure gperftools时。添加<strong>--enable-frame-pointers</strong>选项，同时在编译目标程序时，添加<strong>-fno-omit-frame-pointer</strong>选项</li>
<li>避免fork<em>（大多数后台都会将其变成后台进程，这其中就会fork）</em></li>
</ol>



<br>
<br>

<script>
(function() {
  var cx = '000743863249122818147:j_aeulgywie';
  var gcse = document.createElement('script'); gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
</script>
<gcse:search></gcse:search>

<hr>
<br>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'qjw'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div id=float_top_right>
<h4>&nbsp;分类浏览[other]</h4>
<ul>
    
    <li>
    <a href="/categories/other/" title="查看此类别的所有文章">
        other(20)</a>
    </li>
    
    <li>
    <a href="/categories/www/" title="查看此类别的所有文章">
        www(10)</a>
    </li>
    
    <li>
    <a href="/categories/bash/" title="查看此类别的所有文章">
        bash(42)</a>
    </li>
    
    <li>
    <a href="/categories/wtl/" title="查看此类别的所有文章">
        wtl(14)</a>
    </li>
    
    <li>
    <a href="/categories/cpp/" title="查看此类别的所有文章">
        cpp(43)</a>
    </li>
    
    <li>
    <a href="/categories/network/" title="查看此类别的所有文章">
        network(15)</a>
    </li>
    
    <li>
    <a href="/categories/windows/" title="查看此类别的所有文章">
        windows(15)</a>
    </li>
    
    <li>
    <a href="/categories/lua/" title="查看此类别的所有文章">
        lua(4)</a>
    </li>
    
    <li>
    <a href="/categories/js/" title="查看此类别的所有文章">
        js(6)</a>
    </li>
    
    <li>
    <a href="/categories/wingui/" title="查看此类别的所有文章">
        wingui(18)</a>
    </li>
    
    <li>
    <a href="/categories/linux/" title="查看此类别的所有文章">
        linux(17)</a>
    </li>
    
    <li>
    <a href="/categories/game/" title="查看此类别的所有文章">
        game(3)</a>
    </li>
    
</ul>
</div>


                </td>
                <td style="width: 210px; ">
                    &nbsp;
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
