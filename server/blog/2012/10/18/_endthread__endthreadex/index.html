<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="/js/jquery-1.7.1.min.js"></script>
	<script type="text/javascript">
    var switch_flag_=0
    $(document).ready(function(){
            $("#float_top_right").css({ top: "10px",right: "10px", width: "200", position: "fixed", background: "#99ff00" })
                .css({"border-style": "solid"});
            $("#float_top_right").prepend("<div id=float_top_right_header>点击切换位置</div>");
            $("#float_top_right_header").css({ width: "100%"}).css({ height: "20"})
                .css({ background: "#9900ff" }).css("cursor","pointer")
            
            // OnClick做实际的事情
            $("#float_top_right_header").click(function(event){
                event.preventDefault();
                if(switch_flag_){
                    $("#float_top_right").css({ bottom: ""});
                    $("#float_top_right").css({ top: "10px"});
                }else{
                    $("#float_top_right").css({ top: ""});
                    $("#float_top_right").css({ bottom: "10px"});
                }
                switch_flag_= !switch_flag_;
            });
	})
	</script>
    <title>_endthread和_endthreadex陷阱</title>
</head>
<body>
    <table align="left" border="0" cellpadding="0" cellspacing="0" style="width: 100%; ">
        <tbody>
            <tr>
                <td>
                    <link href="/js/google-code-prettify/prettify.css" type="text/css" rel="stylesheet"/>
<script type="text/javascript" src="/js/google-code-prettify/prettify.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $('pre').addClass('prettyprint linenums:0') //添加Google code Hight需要的class
	
	// 导入Prettify的javascript
    prettyPrint()
})
</script>
<strong>导航：[<a href="/">首页</a>]->[<a href="/categories/windows/">windows</a>]->[<a href="/blog/2012/10/18/_endthread__endthreadex">_endthread和_endthreadex陷阱</a>]</strong>

<h3>Msdn见<a href="http://msdn.microsoft.com/en-us/library/hw264s73(v=vs.80).aspx">这里</a>和<a href="http://msdn.microsoft.com/en-us/library/kdzttdcb(v=vs.80).aspx">这里</a></h3>

<ul>
<li>_beginthreadex是微软的C/C++运行时库函数，CreateThread是操作系统的函数。_beginthreadex通过调用CreateThread来实现的，但比CreateThread多做了许多工作。 注意：若要创建一个新线程，绝对不要使用CreateThread，而应使用_beginthreadex. Why?考虑标准C运行时库的一些变量和函数，如errno，这是一个全局变量。全局变量用于 多线程会出什么事，你一定知道的了。故必须存在一种机制，使得每个线程能够引用它自己的 errno变量，又不触及另一线程的errno变量._beginthreadex就为每个线程分配自己的 tiddata内存结构。该结构保存了许多像errno这样的变量和函数的值、地址（自己看去吧）。 通过线程局部存储将tiddata与线程联系起来。具体实现在Threadex.c中有。 结束线程使用函数__endthreadex函数，释放掉线程的tiddata数据块。</li>
<li>_beginthread returns -1L on an error. _beginthreadex returns 0 on an error(注意返回值别搞混了)</li>
<li>_endthread automatically closes the thread handle (whereas _endthreadex does not). Therefore, when using _beginthread and _endthread, do not explicitly close the thread handle by calling the Win32 CloseHandle API. (_endthread会自动关闭句柄，所以不要在显式的关闭之，也不要用它来Wait什么的，而_beginthreadex则需要明确地CloseHandle)</li>
<li>You can call _endthread or _endthreadex explicitly to terminate a thread; however, _endthread or _endthreadex is called automatically when the thread returns from the routine passed as a parameter to _beginthread or _beginthreadex.（可以不用显式地去调用）</li>
<li>_endthread and _endthreadex cause C++ destructors pending in the thread not to be called.(直接调用会导致C++对象析构函数不被调用，当然若你没有显式或者隐式的C++对象，那就没问题)</li>
<li>It is safer to use _beginthreadex than _beginthread. If the thread generated by _beginthread exits quickly, the handle returned to the caller of _beginthread might be invalid or, worse, point to another thread. (尽量使用_beginthreadex)</li>
</ul>


<h2>Sample</h2>

<pre><code>    // crt_BEGTHRD.C
    // compile with: /MT /D "_X86_" /c
    // processor: x86
    #include &lt;windows.h&gt;
    #include &lt;process.h&gt;    /* _beginthread, _endthread */
    #include &lt;stddef.h&gt;
    #include &lt;stdlib.h&gt;
    #include &lt;conio.h&gt;

    void Bounce( void *ch );
    void CheckKey( void *dummy );

    /* GetRandom returns a random integer between min and max. */
    #define GetRandom( min, max ) ((rand() % (int)(((max) + 1) - (min))) + (min))

    BOOL repeat = TRUE;     /* Global repeat flag and video variable */
    HANDLE hStdOut;         /* Handle for console window */
    CONSOLE_SCREEN_BUFFER_INFO csbi;    /* Console information structure */

    int main()
    {
        CHAR    ch = 'A';

        hStdOut = GetStdHandle( STD_OUTPUT_HANDLE );

        /* Get display screen's text row and column information. */
       GetConsoleScreenBufferInfo( hStdOut, &amp;csbi );

        /* Launch CheckKey thread to check for terminating keystroke. */
        _beginthread( CheckKey, 0, NULL );

        /* Loop until CheckKey terminates program. */
        while( repeat )
        {
            /* On first loops, launch character threads. */
            _beginthread( Bounce, 0, (void *) (ch++)  );

            /* Wait one second between loops. */
            Sleep( 1000L );
        }
    }

    /* CheckKey - Thread to wait for a keystroke, then clear repeat flag. */
    void CheckKey( void *dummy )
    {
        _getch();
        repeat = 0;    /* _endthread implied */

    }

    /* Bounce - Thread to create and and control a colored letter that moves
     * around on the screen.
     *
     * Params: ch - the letter to be moved
     */
    void Bounce( void *ch )
    {
        /* Generate letter and color attribute from thread argument. */
        char    blankcell = 0x20;
        char    blockcell = (char) ch;
        BOOL    first = TRUE;
       COORD   oldcoord, newcoord;
       DWORD   result;


        /* Seed random number generator and get initial location. */
        srand( _threadid );
        newcoord.X = GetRandom( 0, csbi.dwSize.X - 1 );
        newcoord.Y = GetRandom( 0, csbi.dwSize.Y - 1 );
        while( repeat )
        {
            /* Pause between loops. */
            Sleep( 100L );

            /* Blank out our old position on the screen, and draw new letter. */
            if( first )
                first = FALSE;
            else
             WriteConsoleOutputCharacter( hStdOut, &amp;blankcell, 1, oldcoord, &amp;result );
             WriteConsoleOutputCharacter( hStdOut, &amp;blockcell, 1, newcoord, &amp;result );

            /* Increment the coordinate for next placement of the block. */
            oldcoord.X = newcoord.X;
            oldcoord.Y = newcoord.Y;
            newcoord.X += GetRandom( -1, 1 );
            newcoord.Y += GetRandom( -1, 1 );

            /* Correct placement (and beep) if about to go off the screen. */
            if( newcoord.X &lt; 0 )
                newcoord.X = 1;
            else if( newcoord.X == csbi.dwSize.X )
                newcoord.X = csbi.dwSize.X - 2;
            else if( newcoord.Y &lt; 0 )
                newcoord.Y = 1;
            else if( newcoord.Y == csbi.dwSize.Y )
                newcoord.Y = csbi.dwSize.Y - 2;

            /* If not at a screen border, continue, otherwise beep. */
            else
                continue;
            Beep( ((char) ch - 'A') * 100, 175 );
        }
        /* _endthread given to terminate */
        _endthread();
    }
</code></pre>

<hr />

<pre><code>    // crt_begthrdex.cpp
    // compile with: /MT
    #include &lt;windows.h&gt;
    #include &lt;stdio.h&gt;
    #include &lt;process.h&gt;

    unsigned Counter; 
    unsigned __stdcall SecondThreadFunc( void* pArguments )
    {
        printf( "In second thread...\n" );

        while ( Counter &lt; 1000000 )
            Counter++;

        _endthreadex( 0 );
        return 0;
    } 

    int main()
    { 
        HANDLE hThread;
        unsigned threadID;

        printf( "Creating second thread...\n" );

        // Create the second thread.
        hThread = (HANDLE)_beginthreadex( NULL, 0, &amp;SecondThreadFunc, NULL, 0, &amp;threadID );

        // Wait until second thread terminates. If you comment out the line
        // below, Counter will not be correct because the thread has not
        // terminated, and Counter most likely has not been incremented to
        // 1000000 yet.
        WaitForSingleObject( hThread, INFINITE );
        printf( "Counter should be 1000000; it is-&gt; %d\n", Counter );
        // Destroy the thread object.
        CloseHandle( hThread );
    }
</code></pre>

<h2>参考：</h2>

<ul>
<li><a href="http://www.cnblogs.com/zhuocheng/archive/2011/10/02/2198329.html">C/C++四种退出线程的方法</a></li>
<li><a href="http://blog.csdn.net/jay329106193/article/details/7679677">_beginthreadex，CreateThread，AfxBeginThread的区别</a></li>
<li><a href="http://www.cppblog.com/eday/archive/2006/11/25/15648.html">是使用__beginthread 还是 CreateThread !</a></li>
<li><a href="http://www.cnblogs.com/-clq/archive/2012/01/05/2312950.html">_beginthreadex 一定要自己写 CloseHandle 可以不用 _endthreadex</a></li>
</ul>



<br>
<br>

<script>
(function() {
  var cx = '000743863249122818147:j_aeulgywie';
  var gcse = document.createElement('script'); gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
</script>
<gcse:search></gcse:search>

<hr>
<br>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'qjw'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div id=float_top_right>
<h4>&nbsp;分类浏览[windows]</h4>
<ul>
    
    <li>
    <a href="/categories/other/" title="查看此类别的所有文章">
        other(20)</a>
    </li>
    
    <li>
    <a href="/categories/www/" title="查看此类别的所有文章">
        www(10)</a>
    </li>
    
    <li>
    <a href="/categories/bash/" title="查看此类别的所有文章">
        bash(42)</a>
    </li>
    
    <li>
    <a href="/categories/wtl/" title="查看此类别的所有文章">
        wtl(14)</a>
    </li>
    
    <li>
    <a href="/categories/cpp/" title="查看此类别的所有文章">
        cpp(43)</a>
    </li>
    
    <li>
    <a href="/categories/network/" title="查看此类别的所有文章">
        network(15)</a>
    </li>
    
    <li>
    <a href="/categories/windows/" title="查看此类别的所有文章">
        windows(15)</a>
    </li>
    
    <li>
    <a href="/categories/lua/" title="查看此类别的所有文章">
        lua(4)</a>
    </li>
    
    <li>
    <a href="/categories/js/" title="查看此类别的所有文章">
        js(6)</a>
    </li>
    
    <li>
    <a href="/categories/wingui/" title="查看此类别的所有文章">
        wingui(18)</a>
    </li>
    
    <li>
    <a href="/categories/linux/" title="查看此类别的所有文章">
        linux(17)</a>
    </li>
    
    <li>
    <a href="/categories/game/" title="查看此类别的所有文章">
        game(3)</a>
    </li>
    
</ul>
</div>


                </td>
                <td style="width: 210px; ">
                    &nbsp;
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
